---
title: "PrismaPromise ã¨ã¯ä½•ã‹"
emoji: "ğŸ°"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Prisma]
published: true
---

## ã¯ã˜ã‚ã«

Node.js ã® TypeScript-friendly ãª ORM ã§ã‚ã‚‹ Prisma ã«ã¤ã„ã¦ã®è¨˜äº‹ã§ã™ã€‚Prisma ã§ã¯ `PrismaPromise` å‹ã®å€¤ãŒã‚ˆãä½¿ã‚ã‚Œã¦ãŠã‚Šã€ãã‚Œã«ã¤ã„ã¦èª¿ã¹ãŸã“ã¨ã¨ã€ãã®è¨­è¨ˆãŒç´ æ™´ã‚‰ã—ã„ç‚¹ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚

## ã‚¯ã‚¨ãƒªã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°

æ¬¡ã®ã‚ˆã†ãª `User` ãƒ¢ãƒ‡ãƒ«ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã¨ãã€

```
model User {
  id    Int     @id @default(autoincrement())
  email String  @unique
}
```

`User` ãƒ¢ãƒ‡ãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®ã‚ˆã†ã«ã—ã¦ä½œæˆã§ãã¾ã™ã€‚

```ts
await prisma.user.create({
  data: {
    email: "foo@example.com",
  },
});
```

ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¦ã¿ã‚‹ã¨ã€ã¡ã‚ƒã‚“ã¨ã‚¯ã‚¨ãƒªãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã¾ã™ã€‚

```
prisma:query BEGIN
prisma:query INSERT INTO `main`.`User` (`email`) VALUES (?) RETURNING id
prisma:query SELECT `main`.`User`.`id`, `main`.`User`.`email` FROM `main`.`User` WHERE `main`.`User`.`id` = ? LIMIT ? OFFSET ?
prisma:query COMMIT
```

ä¸€è¦‹ã™ã‚‹ã¨ã€`prisma.user.create` ã®è¿”ã‚Šå€¤ã¯ `Promise` ã§ãƒ©ãƒƒãƒ—ã•ã‚ŒãŸå€¤ã§ã€ãã‚Œã‚’ `await` ã§ fulfilled ã«ãªã‚‹ã®ã‚’å¾…æ©Ÿã—ã¦ã„ã‚‹ã‚ˆã†ã«æ€ãˆã¾ã™ã€‚ã—ã‹ã—ã€æ¬¡ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§ã¯ã‚¯ã‚¨ãƒªã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚

```ts
// await ã›ãšã€éåŒæœŸã§ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦ãŠã
prisma.user.create({
  data: {
    email: "foo@example.com",
  },
});

console.log("waiting...");

// ã‚¯ã‚¨ãƒªã®å®Ÿè¡ŒãŒå®Œäº†ã™ã‚‹ã¾ã§ååˆ†ãªæ™‚é–“å¾…ã£ã¦ã¿ã‚‹
await setTimeout(5000);

console.log("done");
```

ã“ã®ã¨ã `"done"` ãŒå‡ºåŠ›ã•ã‚ŒãŸå¾Œã‚‚ã‚¯ã‚¨ãƒªã®ãƒ­ã‚°ã¯å‡ºåŠ›ã•ã‚Œãšã€ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚‚ä½œæˆã•ã‚Œã¾ã›ã‚“ã€‚`findMany` ã‚„ `$executeRaw` ãªã©ã€DB å•ã„åˆã‚ã›ãŒç™ºç”Ÿã™ã‚‹ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚‚åŒæ§˜ã§ã™ã€‚ãªãœã“ã®ã‚ˆã†ãªã“ã¨ãŒèµ·ã“ã‚‹ã®ã‹ã€èª¬æ˜ã™ã‚‹å‰ã«ã¾ãš Thenable ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¤ã„ã¦çŸ¥ã£ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## Thenable ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

Thenable ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ `then` ã¨ã„ã†åå‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚ã—ãã¯ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚

```ts
const thenable1 = {
  then: function (resolved) {
    resolved();
  },
};

// ã“ã‚Œã‚‚ Thenable ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
const thenable2 = {
  then(resolved) {
    resolved();
  },
};

// ã“ã‚Œã‚‚ Thenable ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
const thenable3 = {
  then: (resolved) => {
    resolved();
  },
};
```

MDN ã®è§£èª¬ã¯ã“ã¡ã‚‰:
https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Operators/await#thenable_objects

Thenable ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ `.then` ã‚’å‘¼ã³å‡ºã™ã€ã‚‚ã—ãã¯ `await` ã™ã‚‹ã“ã¨ã§å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
const thenable = {
  then: (resolve) => {
    console.log("foo");
    resolve();
  },
};

thenable.then(() => {}); // "foo"

// ã‚‚ã—ãã¯

await thenable; // "foo"
```

å…ˆã«çµè«–ã‚’è¿°ã¹ã‚‹ã¨ã€`prisma.user.create` ã®è¿”ã‚Šå€¤ã®æ­£ä½“ã¯ Thenable ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã ã£ãŸã¨ã„ã†ã‚ã‘ã§ã™ã€‚æ¬¡ã®ç¯€ã§ã¯ Prisma ã®å®Ÿè£…ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

## PrismaPromise

`prisma.user.create` ã®è¿”ã‚Šå€¤ã®å‹ã‚’èª¿ã¹ã¦ã¿ã‚‹ã¨ `Prisma.Prisma__UserClient<User>` ã¨ã„ã†ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãªã£ã¦ãŠã‚Šã€ã“ã®ã‚¯ãƒ©ã‚¹ã¯ `Promise` ã‚’ç¶™æ‰¿ã—ãŸ `PrismaPromise` ã¨ã„ã† interface ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚`PrismaPromise` ã¯ä¸‹è¨˜ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://github.com/prisma/prisma/blob/f0631b2d97b895645b35a40d0327aa58191ce056/packages/client/src/runtime/getPrismaClient.ts#L1532-L1550

ã¾ãŸã€`PrismaPromise` ã®å‹å®šç¾©ã®ã™ãä¸‹ã« `createPrismaPromise` ã¨ã„ã†é–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ãŠã‚Šã€ã‚³ãƒ¡ãƒ³ãƒˆã§æ¬¡ã®ã‚ˆã†ãªã“ã¨ãŒæ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

> Creates a [[PrismaPromise]]. It is Prisma's implementation of `Promise` which is essentially a proxy for `Promise`. All the transaction-compatible client methods return one, this allows for pre-preparing queries without executing them until `.then` is called. It's the foundation of Prisma's query batching.

ã¤ã¾ã‚Šã€`PrismaPromise` ã¯ Prisma ã«ã‚ˆã‚‹ `Promise` ã®å®Ÿè£…ã§ã€**transaction ã«å¯¾å¿œã—ãŸã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆ`prisma.user.create` ãªã©ï¼‰ã¯ `PrismaPromise` ã‚’è¿”ã—ã¦ãŠã‚Šã€ `.then` ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã¾ã§ï¼ˆã‚‚ã—ãã¯ `await` ã™ã‚‹ã¾ã§ï¼‰ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã›ãšã«äº‹å‰æº–å‚™ã™ã‚‹ã“ã¨ãŒã§ãã‚‹**ã¨ã„ã†ã“ã¨ã§ã™ã€‚å®Ÿéš›ã« `createPrismaPromise` ã®å®Ÿè£…ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€è¿”ã‚Šå€¤ã¯ Thenable ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãªã£ã¦ãŠã‚Šã€ã‚¯ã‚¨ãƒªã¯ `.then` ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

## PrismaPromise ã‚’æ´»ç”¨ã—ãŸæ©Ÿèƒ½

ã“ã“ã‹ã‚‰å…ˆã¯ä½™è«‡ã§ã™ã€‚`PrismaPromise` ã‚’ç†è§£ã—ãŸä¸Šã§ã€ã“ã‚Œã‚’æ´»ç”¨ã—ãŸ Prisma ã®æ©Ÿèƒ½ã® `$transaction` API ã¨ Fluent API ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

### `$transaction` API

Prisma ã«ã¯ã€æ¬¡ã®ã‚ˆã†ãª transaction ã®ãŸã‚ã® API ãŒã‚ã‚Šã¾ã™ã€‚

```ts
const createUser = prisma.user.create({
  // ...
});

const updateUser = prisma.user.update({
  // ...
});

const deleteUser = prisma.user.delete({
  // ...
});

await prisma.$transaction([createUser, updateUser, deleteUser]);
```

`prisma.$transaction` ã¯å¼•æ•°ã« `PrismaPromise` ã®é…åˆ—ã‚’å—ã‘ä»˜ã‘ã€é…åˆ—ã®å…ˆé ­ã‹ã‚‰é †ç•ªã«ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦ã„ãã€å¤±æ•—ã—ãŸã‚¯ã‚¨ãƒªãŒã‚ã£ãŸå ´åˆã™ã¹ã¦ã®å¤‰æ›´ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™ã€‚ã“ã‚Œã¯ Prisma ãŒ `PrismaPromise` ã‚’è¿”ã™ï¼ˆã‚¯ã‚¨ãƒªã®å®Ÿè¡Œã‚’ä¿ç•™ã™ã‚‹ï¼‰ã¨ã„ã†è¨­è¨ˆã«ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦å®Ÿç¾ã•ã‚Œã¦ã„ã‚‹ API ã® 1 ã¤ã§ã™ã­ã€‚

https://www.prisma.io/docs/guides/performance-and-optimization/prisma-client-transactions-guide#transaction-api

### Fluent API

`User` ã¨ `Post` ãŒ 1-n ã®é–¢ä¿‚ã«ã‚ã‚‹ã¨ãã€ã‚ã‚‹ `User` ã® `Post` ã‚’è¤‡æ•°å–å¾—ã™ã‚‹ã¨ãã¯æ¬¡ã®ã‚ˆã†ã«æ›¸ã‘ã¾ã™ã€‚

```ts
const posts = await prisma.post.findMany({
  where: {
    userId: 42,
  },
});
```

ã“ã‚Œã‚’ 3 ã¤ã® `userId` åˆ†ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã‚ˆã†ã¨ã™ã‚‹ã¨æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```ts
const getPosts1 = prisma.post.findMany({
  where: {
    userId: 42,
  },
});

const getPosts2 = prisma.post.findMany({
  where: {
    userId: 43,
  },
});

const getPosts3 = prisma.post.findMany({
  where: {
    userId: 44,
  },
});

const [posts1, posts2, posts3] = await Promise.all([
  getPosts1,
  getPosts2,
  getPosts3,
]);
```

ã“ã®ã¨ãã‚¯ã‚¨ãƒªã¯ 3 å›å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```
prisma:query SELECT `main`.`Post`.`id`, `main`.`Post`.`title`, `main`.`Post`.`content`, `main`.`Post`.`userId` FROM `main`.`Post` WHERE `main`.`Post`.`userId` = ? LIMIT ? OFFSET ?
prisma:query SELECT `main`.`Post`.`id`, `main`.`Post`.`title`, `main`.`Post`.`content`, `main`.`Post`.`userId` FROM `main`.`Post` WHERE `main`.`Post`.`userId` = ? LIMIT ? OFFSET ?
prisma:query SELECT `main`.`Post`.`id`, `main`.`Post`.`title`, `main`.`Post`.`content`, `main`.`Post`.`userId` FROM `main`.`Post` WHERE `main`.`Post`.`userId` = ? LIMIT ? OFFSET ?
```

Prisma ã«ã¯ä¸Šè¨˜ã®ã‚ˆã†ãªå ´åˆã«ãŠã„ã¦ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’åŠ¹ç‡çš„ã«å–å¾—ã™ã‚‹ãŸã‚ã®ä»•çµ„ã¿ã¨ã—ã¦ Fluent API ã¨ã„ã†æ©Ÿèƒ½ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚Fluent API ã‚’ä½¿ã†ã¨ã€åŒä¸€ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã«ç™ºç”Ÿã—ãŸåŒã˜ where ã¨ select ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒã¤ã‚¯ã‚¨ãƒªã‚’ 1 ã¤ã®ã‚¯ã‚¨ãƒªã«æœ€é©åŒ–ã—ã¦ãã‚Œã¾ã™ã€‚ã„ã‚ã‚†ã‚‹ DataLoader ã§ã€GraphQL ã«ãŠã„ã¦ N+1 å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã®ä»•çµ„ã¿ãªã©ã«ä½¿ã‚ã‚Œã¾ã™ã€‚

https://www.prisma.io/docs/concepts/components/prisma-client/relation-queries#fluent-api

Fluent API ã‚’ä½¿ã†ã¨æ¬¡ã®ã‚ˆã†ã«æ›¸ã‘ã¾ã™ã€‚

```ts
const getPosts1 = prisma.user
  .findUnique({
    where: {
      id: 42,
    },
  })
  .posts();

const getPosts2 = prisma.user
  .findUnique({
    where: {
      id: 43,
    },
  })
  .posts();

const getPosts3 = prisma.user
  .findUnique({
    where: {
      id: 44,
    },
  })
  .posts();

const [posts1, posts2, posts3] = await Promise.all([
  getPosts1,
  getPosts2,
  getPosts3,
]);
```

ã“ã®ã¨ãã€ã‚¯ã‚¨ãƒªã¯ 2 å›ã—ã‹å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚ã¾ãŸã€å–å¾—ã™ã‚‹ `User` ã®æ•°ã‚’ã„ãã‚‰å¢—ã‚„ã—ã¦ã‚‚ 2 å›ã‹ã‚‰å¤‰ã‚ã‚Šã‚ã‚Šã¾ã›ã‚“ã€‚

```
prisma:query SELECT `main`.`User`.`id` FROM `main`.`User` WHERE `main`.`User`.`id` IN (?,?,?) LIMIT ? OFFSET ?
prisma:query SELECT `main`.`Post`.`id`, `main`.`Post`.`title`, `main`.`Post`.`content`, `main`.`Post`.`userId` FROM `main`.`Post` WHERE `main`.`Post`.`userId` IN (?) LIMIT ? OFFSET ?
```

ã“ã¡ã‚‰ã‚‚ `PrismaPromise` ã‚’è¿”ã™ã¨ã„ã†è¨­è¨ˆã«ã‚ˆã‚‹æ©æµã® 1 ã¤ã§ã—ãŸã€‚
